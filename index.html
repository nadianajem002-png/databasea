<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medication DB — Email Sign-In</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:980px;margin:24px auto;padding:0 12px}
    h1{font-size:22px;margin:0 0 12px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:14px 0}
    .grid{display:grid;grid-template-columns:2fr 1fr 1fr 2fr auto;gap:8px}
    input,button{padding:8px;border:1px solid #cbd5e1;border-radius:8px}
    button{cursor:pointer}
    .row{display:grid;grid-template-columns:2fr 1fr 1fr 2fr auto;gap:8px;align-items:center}
    ul{list-style:none;margin:0;padding:0}
    li{border:1px solid #f1f5f9;border-radius:10px;padding:10px;margin:8px 0}
    .muted{color:#64748b;font-size:12px}
    .ok{color:#065f46}
    .bad{color:#b91c1c}
    .flex{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none}
    .right{float:right}
    .auth-grid{display:grid;grid-template-columns:1fr 1fr auto auto auto;gap:8px}
  </style>
</head>
<body>
  <h1>Medication Database <span class="muted">— saved to your email account</span></h1>

  <div class="card" id="auth-card">
    <div class="auth-grid">
      <input id="email" type="email" placeholder="Email" autocomplete="username" />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="signup">Sign up</button>
      <button id="signin">Sign in</button>
      <button id="reset">Reset password</button>
    </div>
    <div class="muted" id="auth-help" style="margin-top:8px">
      New here? Enter email + password and click <em>Sign up</em>. Already have an account? <em>Sign in</em>.
      <button id="signout" class="right">Sign out</button>
    </div>
    <div id="status" class="muted" style="margin-top:6px">Not signed in.</div>
    <div id="err" class="bad" style="margin-top:6px;display:none"></div>
  </div>

  <div class="card hidden" id="app-card">
    <div class="grid">
      <input id="name" placeholder="Drug (e.g., Clopidogrel)" />
      <input id="dose" placeholder="Dose (e.g., 75 mg)" />
      <input id="route" placeholder="Route (PO, IV…)" />
      <input id="freq" placeholder="Frequency (daily, q6h…)" />
      <button id="add">Add</button>
    </div>
    <div class="muted" style="margin-top:8px">Signed in as <span id="who"></span>. Your list is private to your account.</div>
  </div>

  <div class="card hidden" id="list-card">
    <strong>Your Medications</strong>
    <ul id="list"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, sendPasswordResetEmail, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      serverTimestamp, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB4SLwd4A3wNrstcHNzuI83z0G8e-1AK50",
         authDomain: "nadia-b4de4.firebaseapp.com",
        projectId: "nadia-b4de4",
        storageBucket: "nadia-b4de4.firebasestorage.app",
        messagingSenderId: "354468688054",
        appId: "1:354468688054:web:9163d3700f3fd4c0097617"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    await setPersistence(auth, browserLocalPersistence);

    const ui = {
      authCard: document.getElementById('auth-card'),
      appCard: document.getElementById('app-card'),
      listCard: document.getElementById('list-card'),
      status: document.getElementById('status'),
      err: document.getElementById('err'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      signup: document.getElementById('signup'),
      signin: document.getElementById('signin'),
      reset: document.getElementById('reset'),
      signout: document.getElementById('signout'),
      who: document.getElementById('who'),
      add: document.getElementById('add'),
      name: document.getElementById('name'),
      dose: document.getElementById('dose'),
      route: document.getElementById('route'),
      freq: document.getElementById('freq'),
      list: document.getElementById('list')
    };

    const show = (el, yes) => el.classList.toggle('hidden', !yes);
    const showError = (e) => { ui.err.style.display='block'; ui.err.textContent = e?.message || String(e); console.error(e); };
    const clearError = () => { ui.err.style.display='none'; ui.err.textContent=''; };

    ui.signup.onclick = async () => {
      clearError();
      try {
        await createUserWithEmailAndPassword(auth, ui.email.value.trim(), ui.password.value);
        ui.status.textContent = "Signed up.";
      } catch (e) { showError(e); }
    };

    ui.signin.onclick = async () => {
      clearError();
      try {
        await signInWithEmailAndPassword(auth, ui.email.value.trim(), ui.password.value);
        ui.status.textContent = "Signed in.";
      } catch (e) { showError(e); }
    };

    ui.reset.onclick = async () => {
      clearError();
      try {
        await sendPasswordResetEmail(auth, ui.email.value.trim());
        ui.status.textContent = "Password reset email sent.";
      } catch (e) { showError(e); }
    };

    ui.signout.onclick = async () => {
      clearError();
      try { await signOut(auth); ui.status.textContent = "Signed out."; }
      catch (e) { showError(e); }
    };

    let unsub = null;
    onAuthStateChanged(auth, (user) => {
      clearError();
      if (!user) {
        ui.status.textContent = "Not signed in.";
        show(ui.appCard, false);
        show(ui.listCard, false);
        return;
      }
      ui.status.innerHTML = "Signed in. <span class='ok'>(Email/Password)</span>";
      ui.who.textContent = user.email || user.uid;

      if (unsub) unsub();
      const drugsCol = collection(db, `users/${user.uid}/drugs`);
      const q = query(drugsCol, orderBy('createdAt','desc'));
      unsub = onSnapshot(q, (snap) => {
        ui.list.innerHTML = "";
        if (snap.empty) {
          const li = document.createElement('li');
          li.textContent = "No medications yet. Add one above.";
          ui.list.appendChild(li);
        } else {
          snap.forEach(docSnap => {
            const d = docSnap.data();
            const li = document.createElement('li');
            li.className = 'row';
            li.innerHTML = `
              <div><strong>${d.name || ''}</strong></div>
              <div>${d.dose || ''}</div>
              <div>${d.route || ''}</div>
              <div>${d.freq || ''}</div>
              <div>
                <button data-act="edit">Edit</button>
                <button data-act="del">Delete</button>
              </div>
            `;
            li.querySelector('[data-act="del"]').onclick = async () => {
              try { await deleteDoc(doc(db, `users/${user.uid}/drugs/${docSnap.id}`)); }
              catch(e){ showError(e); }
            };
            li.querySelector('[data-act="edit"]').onclick = async () => {
              try {
                const name = prompt("Drug name", d.name || "");
                if (name === null) return;
                const dose = prompt("Dose", d.dose || "");
                if (dose === null) return;
                const route = prompt("Route", d.route || "");
                if (route === null) return;
                const freq = prompt("Frequency", d.freq || "");
                if (freq === null) return;
                await updateDoc(doc(db, `users/${user.uid}/drugs/${docSnap.id}`), { name, dose, route, freq });
              } catch(e){ showError(e); }
            };
            ui.list.appendChild(li);
          });
        }
      });
      show(ui.appCard, true);
      show(ui.listCard, true);
    });

    ui.add.onclick = async () => {
      clearError();
      const user = auth.currentUser;
      if (!user) { ui.status.textContent = "Please sign in first."; return; }
      const name = ui.name.value.trim();
      if (!name) { ui.name.focus(); return; }
      try {
        await addDoc(collection(db, `users/${user.uid}/drugs`), {
          name,
          dose: ui.dose.value.trim(),
          route: ui.route.value.trim(),
          freq: ui.freq.value.trim(),
          createdAt: serverTimestamp()
        });
        ui.name.value = ui.dose.value = ui.route.value = ui.freq.value = "";
        ui.name.focus();
      } catch(e){ showError(e); }
    };
  </script>
</body>
</html>
