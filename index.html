<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal Medication Database (Perâ€‘User)</title>
  <style>
    :root{
      --bg:#0e1324; --fg:#eaf0ff; --mut:#b8c0ea; --card:#161e3b; --line:#2b376d; --accent:#8ab4ff; --bad:#ff7a7a; --good:#7affba;
      --shadow:0 6px 18px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.02);
      --stripe: rgba(255,255,255,.02);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin:2px 0 14px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .btn{border:1px solid var(--line);background:transparent;color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:620px){.grid{grid-template-columns:1fr}}
    .med-card{position:relative}
    .toolbar{position:absolute;top:10px;right:10px;display:flex;gap:6px}
    .iconbtn{border:1px solid var(--line);background:transparent;color:var(--fg);padding:6px 8px;border-radius:10px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Medication Database</h1>
      <div class="card" style="display:flex;gap:8px;align-items:center">
        <span id="auth-status">Signed out</span>
        <input id="auth-email" type="email" placeholder="email" />
        <input id="auth-pass" type="password" placeholder="password" />
        <button id="btn-signup" class="btn">Sign up</button>
        <button id="btn-signin" class="btn">Sign in</button>
        <button id="btn-signout" class="btn" style="display:none">Sign out</button>
        <button id="btn-export" class="btn">Export JSON</button>
        <button id="btn-import" class="btn">Import JSON</button>
        <input id="file-import" type="file" accept="application/json" style="display:none" />
      </div>
    </header>

    <section class="card">
      <h2>Add / Edit medication</h2>
      <form id="med-form">
        <input id="med-name" placeholder="Name" required />
        <input id="med-route" placeholder="Route" />
        <input id="med-class" placeholder="Class" />
        <input id="med-dose" placeholder="Dose" />
        <textarea id="med-indications" placeholder="Indications"></textarea>
        <textarea id="med-contra" placeholder="Contraindications"></textarea>
        <textarea id="med-lactation" placeholder="Pregnancy/Lactation notes"></textarea>
        <textarea id="med-sidefx" placeholder="Side Effects"></textarea>
        <textarea id="med-interactions" placeholder="Drug Interactions"></textarea>
        <textarea id="med-monitoring" placeholder="Monitoring Parameters"></textarea>
        <textarea id="med-notes" placeholder="Additional Notes"></textarea>
        <div>
          <button type="submit" class="btn">Save</button>
          <button type="button" id="btn-reset" class="btn">Reset</button>
        </div>
        <input type="hidden" id="med-id" />
      </form>
    </section>

    <section>
      <div id="meds-grid" class="grid"></div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB4SLwd4A3wNrstcHNzuI83z0G8e-1AK50",
      authDomain: "nadia-b4de4.firebaseapp.com",
      projectId: "nadia-b4de4",
      storageBucket: "nadia-b4de4.firebasestorage.app",
      messagingSenderId: "354468688054",
      appId: "1:354468688054:web:9163d3700f3fd4c0097617"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = sel => document.querySelector(sel);
    const gridEl = $("#meds-grid");
    const idEl = $("#med-id");

    const inputIds = ["#med-name","#med-route","#med-class","#med-dose","#med-indications","#med-contra","#med-lactation","#med-sidefx","#med-interactions","#med-monitoring","#med-notes"];
    const inputs = Object.fromEntries(inputIds.map(id=>[id,$(id)]));

    function clearForm(){Object.values(inputs).forEach(i=>i.value="");idEl.value="";}

    const btnUp = $("#btn-signup"), btnIn = $("#btn-signin"), btnOut = $("#btn-signout"), statusEl=$("#auth-status"), emailEl=$("#auth-email"), passEl=$("#auth-pass");
    btnUp.onclick=()=>createUserWithEmailAndPassword(auth,emailEl.value,passEl.value).catch(e=>alert(e.message));
    btnIn.onclick=()=>signInWithEmailAndPassword(auth,emailEl.value,passEl.value).catch(e=>alert(e.message));
    btnOut.onclick=()=>signOut(auth);

    let unsub=null;
    onAuthStateChanged(auth,user=>{
      if(user){
        statusEl.textContent=`Signed in as ${user.email}`;
        btnOut.style.display=''; btnUp.style.display=btnIn.style.display='none'; emailEl.style.display=passEl.style.display='none';
        const medsRef=collection(db,`users/${user.uid}/medications`);
        const q=query(medsRef,orderBy('createdAt','desc'));
        if(unsub)unsub(); unsub=onSnapshot(q,snap=>{renderMeds(snap.docs.map(d=>({id:d.id,...d.data()})));});
      } else {
        statusEl.textContent='Signed out';
        btnOut.style.display='none'; btnUp.style.display=btnIn.style.display=''; emailEl.style.display=passEl.style.display='';
        if(unsub){unsub(); unsub=null;} renderMeds([]);
      }
    });

    $("#med-form").addEventListener('submit',async e=>{
      e.preventDefault(); const user=auth.currentUser; if(!user)return alert('Sign in first.');
      const payload={}; inputIds.forEach(id=>payload[id.slice(5)]=inputs[id].value.trim()); payload.createdAt=serverTimestamp(); payload.updatedAt=serverTimestamp();
      try{ if(idEl.value){await updateDoc(doc(db,`users/${user.uid}/medications/${idEl.value}`),payload);} else {await addDoc(collection(db,`users/${user.uid}/medications`),payload);} clearForm(); }catch(err){alert(err.message)}
    });
    $("#btn-reset").onclick=clearForm;

    async function handleDelete(id){const user=auth.currentUser;if(!user)return;if(!confirm('Delete?'))return;await deleteDoc(doc(db,`users/${user.uid}/medications/${id}`));}
    function handleEdit(m){idEl.value=m.id; for(const id of inputIds){inputs[id].value=m[id.slice(5)]||'';} window.scrollTo({top:0,behavior:'smooth'});}

    function renderMeds(meds){gridEl.innerHTML=''; for(const m of meds){const el=document.createElement('div'); el.className='card med-card'; el.innerHTML=`<div class="toolbar"><button class="iconbtn" data-edit>âœŽ</button><button class="iconbtn" data-del>ðŸ—‘</button></div><div><strong>${escapeHTML(m.name||'(unnamed)')}</strong></div><div>${escapeHTML(m.class||'')}</div><div>${escapeHTML(m.route||'')} ${escapeHTML(m.dose||'')}</div><div>Indications: ${escapeHTML(m.indications||'')}</div><div>Contraindications: ${escapeHTML(m.contra||'')}</div><div>Lactation: ${escapeHTML(m.lactation||'')}</div><div>Sidefx: ${escapeHTML(m.sidefx||'')}</div><div>Interactions: ${escapeHTML(m.interactions||'')}</div><div>Monitoring: ${escapeHTML(m.monitoring||'')}</div><div>Notes: ${escapeHTML(m.notes||'')}</div>`; el.querySelector('[data-edit]').onclick=()=>handleEdit(m); el.querySelector('[data-del]').onclick=()=>handleDelete(m.id); gridEl.appendChild(el);} }

    function escapeHTML(str){return(str||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#039;'}[c]));}

    // Import / Export
    const btnExport=$("#btn-export"),btnImport=$("#btn-import"),fileImport=$("#file-import");
    btnExport.onclick=exportMeds; btnImport.onclick=()=>fileImport.click(); fileImport.onchange=async e=>{const f=e.target.files?.[0];if(!f)return;try{const text=await f.text();const parsed=JSON.parse(text);await importMeds(parsed);alert('Import complete');}catch(err){alert('Import failed:'+err.message);}fileImport.value='';};
    async function exportMeds(){const user=auth.currentUser;if(!user)return alert('Sign in first.');const medsSnap=await getDocs(collection(db,`users/${user.uid}/medications`));const meds=medsSnap.docs.map(d=>({id:d.id,...d.data()}));const blob=new Blob([JSON.stringify(meds,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`meds-${user.uid}.json`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}
    async function importMeds(data){const user=auth.currentUser;if(!user)return alert('Sign in first.');const items=Array.isArray(data)?data:(Array.isArray(data?.medications)?data.medications:null);if(!items)throw new Error('Invalid JSON');const batch=writeBatch(db);for(const raw of items){const m=normalizeMed(raw);const ref=doc(collection(db,`users/${user.uid}/medications`));batch.set(ref,{...m,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});}await batch.commit();}
    function normalizeMed(o){return {name:o.name||'',route:o.route||'',class:o.class||'',dose:o.dose||'',indications:o.indications||'',contra:o.contraindications||o.contra||'',lactation:o.lactation||'',sidefx:o.sidefx||'',interactions:o.interactions||'',monitoring:o.monitoring||'',notes:o.notes||''}};
  </script>
</body>
</html>
